<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Insertar Angularjs En Drupal</title><meta name="description" content="Hace poco me encontré con el reto de buscar una forma elegante de introducir Angular en un bloque de Drupal; pero además de eso, en Angular…"><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Insertar Angularjs En Drupal</h1>
</header>
<section data-field="subtitle" class="p-summary">
Hace poco me encontré con el reto de buscar una forma elegante de introducir Angular en un bloque de Drupal; pero además de eso, en Angular…
</section>
<section data-field="body" class="e-content">
<section name="306a" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="e2a5" id="e2a5" class="graf graf--h3 graf--leading graf--title">Insertar Angularjs En Drupal</h3><p name="41fb" id="41fb" class="graf graf--p graf-after--h3">Hace poco me encontré con el reto de buscar una forma elegante de introducir Angular en un bloque de Drupal; pero además de eso, en Angular debía acceder a unas variables de Drupal (Drupal.settings). ¿Cómo resolver esto? Justamente de eso tratará este post.</p><p name="acfc" id="acfc" class="graf graf--p graf-after--p">Empecemos desde el lado php; aquí necesitamos implementar hook_block_info y hook_block_view para crear un bloque. Según la documentación de hook_block_view, debemos devolver un arreglo con subject (título del bloque) y content. Este índice content puede ser markup o un arreglo rendereable; siendo esta segunda la opción recomendada; tomémosla.</p><pre name="cc1f" id="cc1f" class="graf graf--pre graf-after--p">/**<br> * Implements hook_block_view().<br> */<br>function mimodulo_block_view($delta) {<br>  $path = drupal_get_path(&#39;module&#39;, &#39;mimodulo&#39;);<br>  $block = array();<br>  switch($delta) {<br>    case &#39;mi_bloque&#39;:<br>      $block = array(<br>        &#39;subject&#39; =&gt; t(&#39;Título de mi bloque&#39;),<br>        &#39;content&#39; =&gt; array(<br>          &#39;#markup&#39; =&gt; theme(&#39;mimodulo_mitema&#39;),<br>          // Usamos #attached para agregar js porque esta es la forma recomendada en lugar de drupal_add_js().<br>          &#39;#attached&#39; =&gt; array(<br>            &#39;js&#39; =&gt; array(<br>              // $settings es un arreglo que contiene los valores que queremos enviar hacia javascript.<br>              0 =&gt; array(<br>                &#39;data&#39; =&gt; array(&#39;mimodulo&#39; =&gt; $settings),<br>                &#39;type&#39; =&gt; &#39;setting&#39;,<br>              ),<br>              $path . &#39;/ruta/a/mis/dependencias.js&#39; =&gt; array(<br>                &#39;type&#39; =&gt; &#39;file&#39;,<br>              ),<br>              // Aquí otros archivos de dependencias.</pre><pre name="3cac" id="3cac" class="graf graf--pre graf-after--pre">              // Este es el archivo principal de nuestra aplicación en angular.<br>              $path . &#39;/js/app/app.module.js&#39; =&gt; array(<br>                &#39;type&#39; =&gt; &#39;file&#39;,<br>              ),<br>              // Este es el controlador main de nuestra aplicación en angular.<br>              $path . &#39;/js/app/main/main.controller.js&#39; =&gt; array(<br>                &#39;type&#39; =&gt; &#39;file&#39;,<br>              ),<br>              // Este es el un factory que vamos a usar para contener los datos provenientes de Drupal..<br>              $path . &#39;/js/components/drupalData/drupalData.service.js&#39; =&gt; array(<br>                &#39;type&#39; =&gt; &#39;file&#39;,<br>              ),<br>            ),<br>          ),<br>         ),<br>      );<br>  }<br>  return $block;<br>}</pre><p name="1c8a" id="1c8a" class="graf graf--p graf-after--pre">No agrego el hook_block_info() y algunos detalles pequeños para no alargar más el post. Empecemos ahora con la parte divertida de esta entrada (javascript).</p><p name="605d" id="605d" class="graf graf--p graf-after--p">Es importante recordar que cuando pasamos variables de php a javascript (a través de settings); esta se guarda en la propiedad settings del objeto global Drupal; sin embargo, necesitamos asegurarnos de que este objeto está listo antes de poder accederlo; y para hacerlo, tenemos que envolver nuestro código en Drupal.behaviors. Los behaviors de Drupal se ejecutan en cada bootstrap del sistema; por ello hay que tener ciertas consideraciones cuando los utilicemos; les recomiendo <a href="https://www.lullabot.com/articles/understanding-javascript-behaviors-in-drupal" data-href="https://www.lullabot.com/articles/understanding-javascript-behaviors-in-drupal" class="markup--anchor markup--p-anchor" target="_blank">este post</a> al respecto. Es por eso, que no queremos que nuestro código de AngularJS se ejecute dentro de los behaviors de Drupal; para ello la arquitectura de nuestro javascript será algo como lo siguiente:</p><ul class="postList"><li name="b8d2" id="b8d2" class="graf graf--li graf-after--p">Creamos el módulo de AngularJS desde el primer momento.</li><li name="9576" id="9576" class="graf graf--li graf-after--li">Dentro de Drupal Behaviors (y dentro de jquery once) capturamos los valores que necesitamos.</li><li name="45ff" id="45ff" class="graf graf--li graf-after--li">En el evento dom ready tomamos el controlador de angular y de este tomamos un service.</li><li name="f519" id="f519" class="graf graf--li graf-after--li">Invocamos una función de este service que a su vez emite un evento de angular.</li><li name="54eb" id="54eb" class="graf graf--li graf-after--li">Este evento lo escuchamos y manejamos en el controlador para preparar todo lo que necesitamos para nuestro template.</li><li name="5879" id="5879" class="graf graf--li graf-after--li">Aplicamos los cambios en el scope del controlador.</li></ul><p name="f700" id="f700" class="graf graf--p graf-after--li">Ahora sí, manos a la obra.</p><h4 name="edb8" id="edb8" class="graf graf--h4 graf-after--p">app.module.js</h4><pre name="2003" id="2003" class="graf graf--pre graf-after--h4">(function () {<br>  &#39;use strict&#39;;</pre><pre name="2754" id="2754" class="graf graf--pre graf-after--pre">  // Creamos el módulo de AngularJS.<br>  angular.module(&#39;mimoduloAngular&#39;, [&#39;ngCookies&#39;, &#39;ngResource&#39;, &#39;ngSanitize&#39;, &#39;ngTouch&#39;]);<br>  Drupal.behaviors.mimodulo = {<br>    attach: function(context) {<br>      // Nos aseguramos de que sólo se ejecute una vez.<br>      jQuery(&#39;#mimoduloId&#39;, context).once(&#39;mimodulo&#39;, mimoduloOnceFunction);<br>      function mimoduloOnceFunction() {<br>        var setting1 = Drupal.settings.mimodulo.setting1;<br>        var setting2 = Drupal.settings.mimodulo.setting2;<br>        var data = {<br>          setting1: setting1,<br>          setting2: setting2<br>        };</pre><pre name="3d1d" id="3d1d" class="graf graf--pre graf-after--pre">        // We need to ensure dom is ready before getting this element.<br>        angular.element(document).ready(setDrupalData);<br>        function setDrupalData() {<br>          // mainController es el ID del elemento en el template que tiene la directiva data-ng-controller<br>          var mainControllerElement = angular.element(document.getElementById(&#39;mainController&#39;));<br>          // A través del injector obtenemos el service donde vamos a enviar los datos.<br>          var drupalDataService = mainControllerElement.injector().get(&#39;drupalDataService&#39;);<br>          drupalDataService.setDrupalData(data);<br>          // Una vez hecho todo necesitamos aplicar el scope para que funcione.<br>          mainControllerElement.scope().$apply();<br>        }<br>      }<br>    }<br>  };<br>})();</pre><h4 name="666e" id="666e" class="graf graf--h4 graf-after--pre">drupalData.service.js</h4><p name="f65d" id="f65d" class="graf graf--p graf-after--h4">En este archivo vamos a crear un service para nuestra aplicación de angular que reciba los datos provenientes del drupal, los guarde en una variable privada, emita un evento de angular y exponga una función para devolver el valor de la variable privada.</p><pre name="73ba" id="73ba" class="graf graf--pre graf-after--p">(function () {<br>  &#39;use strict&#39;;</pre><pre name="c2bb" id="c2bb" class="graf graf--pre graf-after--pre">  angular.module(&#39;mimoduloAngular&#39;).factory(&#39;drupalDataService&#39;, drupalDataService);</pre><pre name="64e9" id="64e9" class="graf graf--pre graf-after--pre">  // Necesitamos $rootScope para emitir el evento desde aquí y que sea accesible desde cualquier controller.<br>  function drupalDataService($rootScope) {<br>    var data = {};</pre><pre name="3efa" id="3efa" class="graf graf--pre graf-after--pre">    function setDrupalData(newData) {<br>      // Aquí manejamos los datos a nuestro antojo y luego los guardamos en la variable data.<br>      data = newData;<br>      // Emitimos un evento para indicar que los datos provenientes de Drupal ya están listos.<br>      $rootScope.$emit(&#39;drupalDataReady&#39;);<br>    }</pre><pre name="dbeb" id="dbeb" class="graf graf--pre graf-after--pre">    function getDrupalData() {<br>      return data;<br>    }</pre><pre name="188e" id="188e" class="graf graf--pre graf-after--pre">    // Exponemos ambas funciones públicamenete para nuestro factory.<br>    return {<br>      setDrupalData: setDrupalData,<br>      getDrupalData: getDrupalData<br>    };<br>  }<br>})();</pre><h4 name="eb6b" id="eb6b" class="graf graf--h4 graf-after--pre">main.controller.js</h4><p name="3f99" id="3f99" class="graf graf--p graf-after--h4">En este archivo vamos a crear un controller que se encargue de preparar los datos necesarios para nuestro template. En dicho controlador, vamos a escuchar el evento, obtener los datos del service, hacer ‘unbind’ al evento para mejorar el rendimiento y luego procesar todo lo que necesitemos.</p><pre name="095b" id="095b" class="graf graf--pre graf-after--p">(function () {<br>  &#39;use strict&#39;;</pre><pre name="c39f" id="c39f" class="graf graf--pre graf-after--pre">  angular.module(&#39;mimoduloAngular&#39;).controller(&#39;mainController&#39;, mainController);</pre><pre name="5643" id="5643" class="graf graf--pre graf-after--pre">  function mainController($rootScope, drupalDataService) {<br>    /* jshint validthis: true */<br>    var main = this;</pre><pre name="cfff" id="cfff" class="graf graf--pre graf-after--pre">    // Escuchemos el evento drupalDataReady para reaccionar a él.<br>    $rootScope.$on(&#39;drupalDataReady&#39;, function() {</pre><pre name="a144" id="a144" class="graf graf--pre graf-after--pre">      // Unbind the event.<br>      var mainDiv = angular.element(document.getElementById(&#39;mainController&#39;));<br>      angular.element(mainDiv).unbind(&#39;drupalDataReady&#39;);</pre><pre name="2134" id="2134" class="graf graf--pre graf-after--pre">      var data = drupalDataService.getDrupalData();<br>      var setting1 = data.setting1;<br>      var setting2 = data.setting2;</pre><pre name="4eae" id="4eae" class="graf graf--pre graf-after--pre">      // Aquí hacemos el procesamiento necesario para que el template funcione correctamente.</pre><pre name="10f1" id="10f1" class="graf graf--pre graf-after--pre">    });<br>  }<br>})();</pre><p name="d447" id="d447" class="graf graf--p graf-after--pre">Con eso, tenemos la estructura deseada para nuestra aplicación de angular; solamente del lado de Drupal nos falta implementar el hook_theme() que es invocado en el hook_block_view(). Dicho hook_theme puede simplemente hacer render a un template ubicado dentro de nuestro módulo.</p><p name="360b" id="360b" class="graf graf--p graf-after--p">De esta forma, podemos incrustar angular dentro de un bloque de Drupal de la manera correcta y evitando tener nuestro código de AngularJS dentro de los Drupal Behaviors para evitar comportamientos inesperados que suelen ocurrir en este contexto.</p><p name="b11f" id="b11f" class="graf graf--p graf-after--p">Este post surgió como parte de un proyecto que estamos desarrollando en <a href="http://www.estudiomanati.com/" data-href="http://www.estudiomanati.com/" class="markup--anchor markup--p-anchor" target="_blank">Manatí</a> en el que estamos desarrollando un módulo que esperamos poder contribuir con la comunidad: <a href="https://github.com/ManatiCR/apachesolr_angularjs_search" data-href="https://github.com/ManatiCR/apachesolr_angularjs_search" class="markup--anchor markup--p-anchor" target="_blank">apachesolr_angularjs_search</a>. Aún está en una etapa muy temprana de desarrollo, pero apenas esté listo lo haremos saber.</p><p name="cfd9" id="cfd9" class="graf graf--p graf-after--p graf--last">Espero que esta entrada les haya sido útil.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@kporras07" class="p-author h-card">Kevin Porras</a> on <a href="https://medium.com/p/4c675604ddfc"><time class="dt-published" datetime="2015-08-25T01:11:38.366Z">August 25, 2015</time></a>.</p><p>Exported from <a href="https://medium.com">Medium</a> on January 11, 2017.</p></footer></article>

</body></html>